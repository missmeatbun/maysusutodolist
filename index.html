<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ÂæÖËæ¶‰∫ãÈ†ÖÁ≥ªÁµ±</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
    }
    header, #editor-panel {
      padding: 20px;
      background: #ffffff;
      border-bottom: 1px solid #ccc;
    }
    #content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #date-list {
      width: 200px;
      background: #f5f5f5;
      border-right: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }
    #date-list button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    #todo-panel {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .section {
      margin-bottom: 20px;
    }
    .section h4 {
      margin: 10px 0;
    }
    .todo-item {
      padding: 10px 15px;
      margin: 5px 0;
      border-radius: 5px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .color1 { background-color: #b71c1c; }
    .color2 { background-color: #fbc02d; color: #000; }
    .color3 { background-color: #388e3c; }
    .action-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      margin-left: 10px;
    }
    .action-btn:hover {
      color: black;
    }
  </style>
</head>
<body>
  <header>
    <h2>ÂæÖËæ¶‰∫ãÈ†ÖÁ≥ªÁµ±</h2>
  </header>

  <div id="editor-panel">
    <input type="text" id="item-text" placeholder="‰∫ãÈ†ÖÂêçÁ®±">
    <input type="date" id="item-date">
    <select id="item-color">
      <option value="color1">ÈùûÂ∏∏ÈáçË¶Å</option>
      <option value="color2">ÈáçË¶Å</option>
      <option value="color3">‰∏ÄËà¨</option>
    </select>
    <button id="create-btn">Êñ∞Â¢û</button>
  </div>

  <div id="content">
    <div id="date-list"></div>
    <div id="todo-panel"></div>
  </div>

  <!-- Firebase CDN (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOGUZy8pM_hieZqzPSrEYdhoJnFb-ubis",
      authDomain: "maysusutodolist.firebaseapp.com",
      projectId: "maysusutodolist",
      storageBucket: "maysusutodolist.firebasestorage.app",
      messagingSenderId: "975249139081",
      appId: "1:975249139081:web:bab395504850d4bfd3ed58"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentDate = '';

    async function fetchTasksForDate(date) {
      try {
        const doc = await db.collection("todos").doc(date).get();
        return doc.exists ? doc.data() : { todo: [], done: [] };
      } catch (error) {
        console.error("ËÆÄÂèñË≥áÊñôÈåØË™§Ôºö", error);
        return { todo: [], done: [] };
      }
    }

    async function saveTasks(date, data) {
      try {
        await db.collection("todos").doc(date).set(data);
      } catch (error) {
        console.error("ÂÑ≤Â≠òË≥áÊñôÈåØË™§Ôºö", error);
      }
    }

    async function renderDateList() {
      try {
        const snapshot = await db.collection("todos").get();
        const list = document.getElementById("date-list");
        list.innerHTML = '';
        snapshot.forEach(doc => {
          const btn = document.createElement("button");
          btn.textContent = doc.id;
          btn.onclick = () => switchDate(doc.id);
          list.appendChild(btn);
        });
      } catch (error) {
        console.error("Ê∏≤ÊüìÊó•ÊúüÊ∏ÖÂñÆÈåØË™§Ôºö", error);
      }
    }

    async function switchDate(date) {
      currentDate = date;
      document.getElementById("item-date").value = date;
      const data = await fetchTasksForDate(date);
      renderTasks(data);
    }

    async function createItem() {
      const text = document.getElementById("item-text").value;
      const color = document.getElementById("item-color").value;
      let date = document.getElementById("item-date").value;
      if (!text.trim()) return;
      if (!date) date = currentDate;
      try {
        const data = await fetchTasksForDate(date);
        const id = `item-${Date.now()}`;
        data.todo.push({ id, text, color });
        await saveTasks(date, data);
        if (currentDate === date) renderTasks(data);
        await renderDateList();
        document.getElementById("item-text").value = "";
      } catch (error) {
        console.error("Êñ∞Â¢û‰∫ãÈ†ÖÈåØË™§Ôºö", error);
        alert("Êñ∞Â¢û‰∫ãÈ†ÖÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÊü•Áúã‰∏ªÊéßÂè∞Êó•Ë™å„ÄÇ");
      }
    }

    async function moveToDone(id) {
      const data = await fetchTasksForDate(currentDate);
      const index = data.todo.findIndex(item => item.id === id);
      if (index !== -1) {
        const [item] = data.todo.splice(index, 1);
        data.done.push(item);
        await saveTasks(currentDate, data);
        renderTasks(data);
      }
    }

    async function moveToTodo(id) {
      const data = await fetchTasksForDate(currentDate);
      const index = data.done.findIndex(item => item.id === id);
      if (index !== -1) {
        const [item] = data.done.splice(index, 1);
        data.todo.push(item);
        await saveTasks(currentDate, data);
        renderTasks(data);
      }
    }

    async function editItem(id) {
      const data = await fetchTasksForDate(currentDate);
      const index = data.todo.findIndex(item => item.id === id);
      if (index !== -1) {
        const item = data.todo[index];
        const newText = prompt("Ë´ãËº∏ÂÖ•Êñ∞ÁöÑ‰∫ãÈ†ÖÂÖßÂÆπÔºö", item.text);
        if (newText && newText.trim() !== "") {
          item.text = newText.trim();
          await saveTasks(currentDate, data);
          renderTasks(data);
        }
      }
    }

    async function deleteItem(id) {
      if (!confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÈ†Ö‰∫ãÈ†ÖÂóéÔºü")) return;
      const data = await fetchTasksForDate(currentDate);
      const index = data.todo.findIndex(item => item.id === id);
      if (index !== -1) {
        data.todo.splice(index, 1);
        await saveTasks(currentDate, data);
        renderTasks(data);
      }
    }

    function renderTasks(data) {
      const panel = document.getElementById("todo-panel");
      panel.innerHTML = '';

      const todoSection = document.createElement("div");
      todoSection.className = "section";
      todoSection.innerHTML = `<h4>ÂæÖËæ¶Ê∏ÖÂñÆ - ${currentDate}</h4>`;
      data.todo.forEach(item => {
        const div = document.createElement("div");
        div.className = `todo-item ${item.color}`;
        div.innerHTML = `
          <span>${item.text}</span>
          <div>
            <button class="action-btn" onclick="editItem('${item.id}')">‚úèÔ∏è</button>
            <button class="action-btn" onclick="deleteItem('${item.id}')">üóëÔ∏è</button>
            <button class="action-btn" onclick="moveToDone('${item.id}')">‚úî</button>
          </div>
        `;
        todoSection.appendChild(div);
      });

      const doneSection = document.createElement("div");
      doneSection.className = "section";
      doneSection.innerHTML = `<h4>Â∑≤ÂÆåÊàê‰∫ãÈ†Ö</h4>`;
      data.done.forEach(item => {
        const div = document.createElement("div");
        div.className = `todo-item ${item.color}`;
        div.innerHTML = `<span>${item.text}</span><button class="action-btn" onclick="moveToTodo('${item.id}')">‚Ü©</button>`;
        doneSection.appendChild(div);
      });

      panel.appendChild(todoSection);
      panel.appendChild(doneSection);
    }

    window.onload = async () => {
      const today = new Date().toISOString().split('T')[0];
      currentDate = today;
      document.getElementById("item-date").value = today;
      await renderDateList();
      await switchDate(today);
      document.getElementById("create-btn").addEventListener("click", createItem);
    };
  </script>
</body>
</html>
